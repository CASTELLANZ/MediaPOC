<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[SP]미디어 POC 리스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Tailwind CSS를 기본으로 사용하되, 추가적인 커스텀 스타일을 적용합니다. */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        /* 알림 메시지 애니메이션 */
        .toast-notification {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        /* 카테고리 태그 활성/비활성 상태 트랜지션 */
        .category-tag {
            transition: all 0.2s ease-in-out;
        }
        /* 파일 업로드 input 숨기기 */
        input[type="file"] {
            display: none;
        }
        /* 수정 모드 input 스타일 */
        .edit-input {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .edit-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">[SP]미디어 POC 리스트</h1>
            <p class="text-slate-500 mt-2">매체명을 검색하거나 카테고리를 선택하여 담당자 정보를 확인하세요.</p>
        </header>
        
        <main>
            <!-- 컨트롤 패널 -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <div class="mb-4">
                    <label for="search-box" class="block text-sm font-medium text-slate-600 mb-2">매체명/담당자 검색</label>
                    <input type="text" id="search-box" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="예: A일보, 김민준...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">카테고리 선택 (중복 가능)</label>
                    <div id="category-tags-container" class="flex flex-wrap gap-2">
                        <!-- 카테고리 태그가 동적으로 여기에 추가됩니다. -->
                    </div>
                </div>
            </div>

            <!-- 신규 추가 버튼 -->
            <div class="mb-6 text-right">
                <button id="add-new-card-button" class="bg-blue-600 text-white font-bold text-sm py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    신규 추가
                </button>
            </div>

            <!-- 결과 영역 -->
            <div id="media-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 매체 정보 카드가 여기에 동적으로 추가됩니다. -->
            </div>
            
            <!-- 결과 없음 메시지 -->
            <div id="no-results" class="text-center py-16 px-6 bg-white rounded-xl shadow-md hidden">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 19L13 13m-2.5-2.5A4.5 4.5 0 115.5 5.5a4.5 4.5 0 014.5 4.5zM21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="mt-2 text-lg font-medium text-slate-800">데이터를 찾을 수 없습니다.</h3>
                <p class="mt-1 text-sm text-slate-500">데이터 파일을 업로드하여 시작하거나 검색어를 확인해 주세요.</p>
            </div>


            <!-- 전체 복사 버튼 컨테이너 -->
            <div id="copy-all-container" class="mt-8 text-center hidden">
                <button id="copy-all-button" class="bg-green-600 text-white font-bold text-sm py-2.5 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors shadow-lg">
                    <svg class="inline-block w-5 h-5 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    검색 결과 복사 (Excel에 붙여넣으세요)
                </button>
            </div>
        </main>

        <footer class="text-center mt-12 py-4 border-t border-slate-200">
             <div class="mb-2">
                <label for="excel-upload" class="text-xs text-slate-500 underline cursor-pointer hover:text-slate-700 transition-colors">
                    데이터파일 관리(SP팀)
                </label>
                <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv">
                <span id="file-name" class="ml-2 text-xs text-slate-500"></span>
             </div>
             <div>
                <p class="text-xs text-slate-400">copyright © digitalFirst All Right Reserved.</p>
             </div>
        </footer>
    </div>

    <script>
        // --- 전역 변수 ---
        let mediaData = [];
        let currentFilteredData = [];

        // --- 요소 선택 ---
        const excelUpload = document.getElementById('excel-upload');
        const fileNameSpan = document.getElementById('file-name');
        const searchBox = document.getElementById('search-box');
        const categoryTagsContainer = document.getElementById('category-tags-container');
        const mediaList = document.getElementById('media-list');
        const noResults = document.getElementById('no-results');
        const toastContainer = document.getElementById('toast-container');
        const copyAllContainer = document.getElementById('copy-all-container');
        const copyAllButton = document.getElementById('copy-all-button');
        const addNewCardButton = document.getElementById('add-new-card-button');

        // --- 데이터 처리 함수 ---
        
        function processRawData(rawData) {
             return rawData.map((row, index) => ({
                ...row,
                id: Date.now() + index, // 수정/삭제를 위한 고유 ID 부여
                카테고리: (row.카테고리 && typeof row.카테고리 === 'string') 
                          ? row.카테고리.split(',').map(cat => cat.trim()) 
                          : (Array.isArray(row.카테고리) ? row.카테고리 : [])
            }));
        }

        function saveDataToLocalStorage(data) {
            localStorage.setItem('mediaPocData', JSON.stringify(data));
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem('mediaPocData');
            if (savedData) {
                return JSON.parse(savedData);
            }
            return [];
        }


        function populateCategories() {
            categoryTagsContainer.innerHTML = '';
            const allCategories = new Set(mediaData.flatMap(item => item.카테고리).filter(Boolean));
            const sortedCategories = [...allCategories].sort();
            
            const allButton = document.createElement('button');
            allButton.className = 'category-tag px-3 py-1.5 rounded-full text-sm font-semibold bg-blue-600 text-white';
            allButton.textContent = '전체';
            allButton.dataset.category = 'all';
            categoryTagsContainer.appendChild(allButton);

            sortedCategories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-tag px-3 py-1.5 rounded-full text-sm font-semibold bg-slate-200 text-slate-700 hover:bg-slate-300';
                button.textContent = category;
                button.dataset.category = category;
                categoryTagsContainer.appendChild(button);
            });
        }

        function renderMedia(data) {
            mediaList.innerHTML = '';
            noResults.classList.toggle('hidden', data.length > 0 || mediaData.length === 0);
            copyAllContainer.classList.toggle('hidden', data.length === 0);

            data.forEach(item => {
                const card = document.createElement('div');
                card.id = `card-${item.id}`;
                card.className = 'bg-white rounded-xl shadow-md p-6 flex flex-col transition-transform transform hover:-translate-y-1';
                card.innerHTML = generateCardView(item);
                mediaList.appendChild(card);
            });
        }
        
        function generateCardView(item) {
            const categoryTagsHtml = (item.카테고리 || []).map(cat => 
                `<span class="text-xs font-semibold text-blue-800 bg-blue-100 px-2 py-1 rounded-full">${cat}</span>`
            ).join('');

            let infoHtml = '';
            const createRow = (label, value, clipValue) => {
                if (!value) return '';
                const copyButton = clipValue ? `<button class="copy-button ml-auto shrink-0" data-clipboard="${clipValue}" aria-label="${label} 복사"><svg class="w-5 h-5 text-slate-400 hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></div>` : '';
                return `<div class="flex items-center"><span class="font-semibold text-slate-500 w-20 shrink-0">${label}</span><span class="text-slate-700 truncate" title="${value}">${value}</span>${copyButton}</div>`;
            };

            const contactPerson = item.담당자 ? `${item.담당자}${item.직책 ? ` / ${item.직책}` : ''}` : '';
            infoHtml += createRow('담당자', contactPerson);
            infoHtml += createRow('개인메일', item.이메일, item.이메일);
            infoHtml += createRow('팀메일', item.팀메일, item.팀메일);
            infoHtml += createRow('연락처', item.연락처, item.연락처);
            infoHtml += createRow('판매 대행사', item['판매 대행사'], item['판매 대행사']);
            
            const introButtonHtml = item['소개서URL']
                ? `<a href="${item['소개서URL']}" target="_blank" rel="noopener noreferrer" class="w-full text-center block bg-blue-500 text-white font-semibold text-sm py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">소개서 다운로드</a>`
                : `<button class="w-full text-center block bg-slate-300 text-slate-500 font-semibold text-sm py-2 px-4 rounded-lg cursor-not-allowed" disabled>소개서 없음</button>`;
            
            return `
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold text-slate-800 pr-2">${item.매체명 || ''}</h2>
                    <button data-action="edit" data-id="${item.id}" class="text-xs text-slate-400 hover:text-blue-600 shrink-0">수정</button>
                </div>
                <div class="flex-grow">
                    <div class="flex flex-wrap gap-2 mb-4">${categoryTagsHtml}</div>
                    <div class="space-y-3 text-sm">${infoHtml}</div>
                </div>
                 <div class="mt-4 pt-4 border-t border-slate-200">
                    ${introButtonHtml}
                </div>
            `;
        }

        function generateCardEditView(item) {
            const createInput = (name, label, value) => `
                <div class="mb-2">
                    <label class="block text-xs font-medium text-slate-500">${label}</label>
                    <input type="text" name="${name}" value="${value || ''}" class="edit-input">
                </div>
            `;
            
            return `
                <form data-id="${item.id}">
                    ${createInput('매체명', '매체명', item.매체명)}
                    ${createInput('카테고리', '카테고리 (쉼표로 구분)', (item.카테고리 || []).join(', '))}
                    ${createInput('담당자', '담당자', item.담당자)}
                    ${createInput('직책', '직책', item.직책)}
                    ${createInput('이메일', '개인메일', item.이메일)}
                    ${createInput('팀메일', '팀메일', item.팀메일)}
                    ${createInput('연락처', '연락처', item.연락처)}
                    ${createInput('판매 대행사', '판매 대행사', item['판매 대행사'])}
                    ${createInput('소개서URL', '소개서URL', item['소개서URL'])}
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" data-action="cancel" data-id="${item.id}" class="px-3 py-1 text-sm rounded-md bg-slate-200 hover:bg-slate-300">취소</button>
                        <button type="button" data-action="save" data-id="${item.id}" class="px-3 py-1 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">저장</button>
                    </div>
                </form>
            `;
        }
        
        function filterAndRender() {
            const searchTerm = searchBox.value.toLowerCase().trim();
            const selectedCategoryNodes = categoryTagsContainer.querySelectorAll('.bg-blue-600');
            const selectedCategories = Array.from(selectedCategoryNodes).map(node => node.dataset.category);
            
            const filteredData = mediaData.filter(item => {
                const matchesSearch = (item.매체명 || '').toLowerCase().includes(searchTerm) || 
                                      (item.담당자 || '').toLowerCase().includes(searchTerm);
                let matchesCategory = true;
                if (selectedCategories.length > 0 && !selectedCategories.includes('all')) {
                    matchesCategory = selectedCategories.some(cat => (item.카테고리 || []).includes(cat));
                }
                return matchesSearch && matchesCategory;
            });
            
            currentFilteredData = filteredData;
            renderMedia(filteredData);
        }

        function copyTextToClipboard(textToCopy) {
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                success = false;
            }
            document.body.removeChild(textArea);
            return success;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `${bgColor} text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg toast-notification opacity-0 transform translate-y-2`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'transform-none');
            }, 10);
            
            // Fade-out and remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        // --- 이벤트 리스너 설정 ---

        addNewCardButton.addEventListener('click', () => {
            const newItem = { id: Date.now(), 매체명: '새 매체' }; // 임시 ID와 이름으로 생성
            
            const card = document.createElement('div');
            card.id = `card-${newItem.id}`;
            card.className = 'bg-white rounded-xl shadow-md p-6 flex flex-col';
            card.dataset.isNew = 'true'; // 새 카드임을 표시
            card.innerHTML = generateCardEditView(newItem);
            
            mediaList.prepend(card);
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        excelUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            fileNameSpan.textContent = file.name;
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    mediaData = processRawData(jsonData);
                    saveDataToLocalStorage(mediaData);

                    showToast(`${mediaData.length}개의 데이터를 성공적으로 불러왔습니다.`, 'success');
                    
                    populateCategories();
                    filterAndRender();

                } catch (error) {
                    console.error("파일 처리 중 오류 발생:", error);
                    showToast("파일을 처리하는 중 오류가 발생했습니다. 파일 형식을 확인해주세요.", "error");
                }
            };
            
            reader.onerror = (error) => {
                console.error("파일 읽기 오류:", error);
                showToast("파일을 읽는 데 실패했습니다.", "error");
            };

            reader.readAsArrayBuffer(file);
        });

        categoryTagsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.category-tag');
            if (!target) return;
            const category = target.dataset.category;
            const allButton = categoryTagsContainer.querySelector('[data-category="all"]');
            if (category === 'all') {
                categoryTagsContainer.querySelectorAll('.category-tag').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                });
                target.classList.add('bg-blue-600', 'text-white');
                target.classList.remove('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
            } else {
                allButton.classList.remove('bg-blue-600', 'text-white');
                allButton.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                target.classList.toggle('bg-blue-600');
                target.classList.toggle('text-white');
                target.classList.toggle('bg-slate-200');
                target.classList.toggle('text-slate-700');
                target.classList.toggle('hover:bg-slate-300');
            }
            const activeTags = categoryTagsContainer.querySelectorAll('.bg-blue-600');
            if (activeTags.length === 0 && allButton) { allButton.click(); }
            filterAndRender();
        });

        let debounceTimer;
        searchBox.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(filterAndRender, 200);
        });
        
        mediaList.addEventListener('click', function(e) {
            const target = e.target.closest('button'); // 버튼만 클릭 대상으로 한정
            if (!target) return;

            const action = target.dataset.action;
            const cardElement = target.closest('[id^="card-"]');
            if (!cardElement) return;

            const id = Number(cardElement.id.replace('card-', ''));
            const itemIndex = mediaData.findIndex(item => item.id === id);

            if (action === 'edit') {
                cardElement.innerHTML = generateCardEditView(mediaData[itemIndex]);
            } else if (action === 'cancel') {
                 if (cardElement.dataset.isNew === 'true') {
                    cardElement.remove(); // 새 카드 추가 중 취소하면 카드 삭제
                 } else {
                    cardElement.innerHTML = generateCardView(mediaData[itemIndex]);
                 }
            } else if (action === 'save') {
                const form = cardElement.querySelector('form');
                const formData = new FormData(form);
                const updatedItem = { id };
                
                for (let [key, value] of formData.entries()) {
                    if (key === '카테고리') {
                         updatedItem[key] = value.split(',').map(v => v.trim()).filter(Boolean);
                    } else {
                        updatedItem[key] = value;
                    }
                }
                
                if (itemIndex > -1) { // 기존 아이템 수정
                    mediaData[itemIndex] = updatedItem;
                } else { // 새 아이템 저장
                    mediaData.unshift(updatedItem);
                }
                
                saveDataToLocalStorage(mediaData);
                populateCategories(); 
                filterAndRender(); 
                showToast('성공적으로 저장되었습니다.', 'success');

            } else if (target.closest('.copy-button')) {
                 const textToCopy = target.closest('.copy-button').dataset.clipboard;
                if (copyTextToClipboard(textToCopy)) {
                    showToast(`'${textToCopy}' 복사 완료!`);
                    const iconContainer = target.closest('.copy-button');
                    iconContainer.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    setTimeout(() => {
                        iconContainer.innerHTML = `<svg class="w-5 h-5 text-slate-400 hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
                    }, 1500);
                } else {
                    showToast('복사에 실패했습니다.', 'error');
                }
            }
        });

        copyAllButton.addEventListener('click', () => {
            if (currentFilteredData.length === 0) {
                showToast('복사할 데이터가 없습니다.', 'error');
                return;
            }
            const header = "매체명\t카테고리\t담당자\t직책\t이메일\t팀메일\t연락처\t판매 대행사\t소개서URL";
            const rows = currentFilteredData.map(item => {
                const categories = (item.카테고리 || []).join(', ');
                return [
                    item.매체명 || '', categories, item.담당자 || '', item.직책 || '',
                    item.이메일 || '', item.팀메일 || '', item.연락처 || '',
                    item['판매 대행사'] || '', item['소개서URL'] || ''
                ].join('\t');
            });
            const textToCopy = [header, ...rows].join('\n');
            
            if(copyTextToClipboard(textToCopy)) {
                showToast(`${currentFilteredData.length}개 매체의 정보가 복사되었습니다!`);
            } else {
                 showToast('전체 복사에 실패했습니다.', 'error');
            }
        });

        // --- 초기 실행 ---
        document.addEventListener('DOMContentLoaded', () => {
            mediaData = loadDataFromLocalStorage();
            if(mediaData.length === 0) {
                 // 데이터가 없을 때만 초기 예시 데이터 사용
                 mediaData = [
                    { "id": 1, "매체명": "A일보", "카테고리": "신문, 온라인", "담당자": "김민준", "직책": "기자", "이메일": "mj.kim@a-news.com", "팀메일": "team.a@a-news.com", "연락처": "010-1111-2222", "판매 대행사": "가나다 대행사", "소개서URL": "https://example.com" },
                    { "id": 2, "매체명": "B 방송국", "카테고리": "방송", "담당자": "이서연", "직책": "PD", "이메일": "sy.lee@b-station.co.kr", "팀메일": "team.b@b-station.co.kr", "연락처": "010-2222-3333", "판매 대행사": "가나다 대행사", "소개서URL": "https://example.com" }
                ];
                mediaData = processRawData(mediaData);
                saveDataToLocalStorage(mediaData);
            }
            populateCategories();
            filterAndRender();
        });
    </script>
</body>
</html>
